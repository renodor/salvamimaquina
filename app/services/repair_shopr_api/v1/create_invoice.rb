# frozen_string_literal: true

class RepairShoprApi::V1::CreateInvoice < RepairShoprApi::V1::Base
  class << self
    def call(order)
      repair_shopr_invoice = {
        # customer_id: TBD
        balance_due: order.total,
        number: order.number,
        date: order.completed_at,
        subtotal: order.item_total,
        total: order.total,
        tax: order.additional_tax_total,
        is_paid: order.payment_state == 'paid',
        # location_id: TBD ??
        # contact_id: TBD ??
        line_items: []
      }

      order.line_items.each do |line_item|
        repair_shopr_invoice[:line_items] << {
          item: line_item.variant.name,
          name: line_item.variant.description,
          product_id: line_item.product.repair_shopr_id,
          quantity: line_item.quantity,
          price: line_item.price,
          taxable: true,
          upc_code: line_item.variant.sku,
          tax_rate_id:  line_item.tax_category.repair_shopr_id
          # user_id: TBD
        }

# Payload generated by this method
# {
#   "balance_due": 255.59,
#   "number": "R338194987",
#   "customer_id": 10527720,
#   "date": "Mon, 12 Apr 2021 03:24:47 +0000",
#   "subtotal": 233.26,
#   "total": 255.59,
#   "tax": 16.33,
#   "is_paid": false,
#   "line_items": [
#     {
#       "item": "IP SE 2 LCD Negro",
#       "name": "IP SE 2 LCD Negro - Garantia de 6 meses",
#       "product_id": 11476993,
#       "quantity": 1, "price": 84.53,
#       "taxable": true,
#       "upc_code": "",
#       "tax_rate_id": 39011
#     }
#   ]
# }

# Payload expected by Repair Shopr

# {
#   "id": 0,
#   "balance_due": 0,
#   "customer_id": 0,
#   "number": "string",
#   "date": "2021-04-12T03:29:35.040Z",
#   "customer_business_then_name": "string",
#   "created_at": "2021-04-12T03:29:35.040Z",
#   "updated_at": "2021-04-12T03:29:35.040Z",
#   "due_date": "2021-04-12",
#   "subtotal": "string",
#   "total": "string",
#   "tax": "string",
#   "verified_paid": true,
#   "tech_marked_paid": true,
#   "ticket_id": 0,
#   "pdf_url": "string",
#   "is_paid": true,
#   "location_id": 0,
#   "po_number": "string",
#   "contact_id": 0,
#   "note": "string",
#   "hardwarecost": 0,
#   "line_items": [
#     {
#       "item": "string",
#       "name": "string",
#       "product_id": 0,
#       "quantity": 0,
#       "cost": 0,
#       "price": 0,
#       "discount_percent": 0,
#       "taxable": true,
#       "upc_code": "string",
#       "tax_note": "string",
#       "wholesale": 0,
#       "invoice_bundle_id": 0,
#       "tax_rate_id": 0,
#       "user_id": 0,
#       "position": 0
#     }
#   ]
# }

        post_invoices(repair_shopr_invoice)
      end
    end
  end
end
